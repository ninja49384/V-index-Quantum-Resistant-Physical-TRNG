<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V-index | Quantum Resistant Physical TRNG</title>
  <style>
    :root { --p:#00ffcc; --bg:#05070a; --gold:#ffd700; --red:#ff4444; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Courier New", monospace;
      background: var(--bg); color: white; text-align: center; margin: 0;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 100vh; overflow: hidden;
    }
    .container {
      z-index:10; width:90%; max-width:780px; max-height: 90vh; padding:15px;
      border:1px solid #1a1d23; background: rgba(13,17,23,0.85);
      border-radius:15px; backdrop-filter: blur(10px);
      box-shadow:0 0 30px rgba(0,255,204,0.1);
      overflow-y: auto; 
    }
    .container::-webkit-scrollbar { width: 5px; }
    .container::-webkit-scrollbar-thumb { background: var(--p); border-radius: 10px; } 
      
    }
    h1 { color: var(--p); font-size: 1.6rem; letter-spacing: 3px; margin-bottom: 5px; }
    .subtitle { color:#9aa; font-size:0.95rem; margin-bottom: 20px; }
    #vNum { font-size:3.2rem; font-weight:bold; margin:8px 0; color:var(--p); transition:0.2s; }
    .key-display {
      background:#000; padding:15px; border-radius:8px;
      border:1px dashed var(--p); word-break:break-all; font-size:1.0rem;
      margin:18px 0; min-height: 80px; display:flex; align-items:center; justify-content:center;
      color: var(--gold); transition:0.3s;
    }
    .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; }
    button {
      padding: 14px 22px; font-size:0.95rem; background:var(--p); border:none; border-radius:50px;
      font-weight:bold; cursor:pointer; transition:0.3s; color:#05070a;
    }
    button:disabled { background:#222 !important; color:#444 !important; cursor:not-allowed; box-shadow:none !important; }
    button:not(:disabled):hover { box-shadow:0 0 20px var(--p); transform: translateY(-2px); }
    .status { font-size:0.86rem; margin-bottom:10px; color:#aaa; height:1.2em; font-weight:bold; text-transform:uppercase; }
    .substatus { font-size:0.78rem; color:#9aa; min-height:1.2em; }
    canvas#visualizer { position: fixed; top:0; left:0; width:100%; height:100%; opacity:0.15; z-index:1; pointer-events:none; }
    .security-info {
      margin-top:16px; background:#10141c; padding:14px; border-radius:10px; text-align:left;
      font-size:0.82rem; line-height:1.5; color:#bbb; border-left:3px solid var(--gold);
    }
    .security-info strong { color:var(--gold); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2c3340; margin-left:6px; font-size:0.72rem; }
    .ok { color:#0fd; border-color:#0fd; }
    .bad { color:#ff6666; border-color:#ff6666; }
    .bit-spark { position:absolute; background:white; border-radius:50%; pointer-events:none; z-index:100; }
    .doi-link { color: var(--p); text-decoration: none; font-weight: bold; }
    .doi-link:hover { text-decoration: underline; }
    #vDetails { margin-top:12px; color:#bbb; font-family: 'Courier New', monospace; font-size:0.85rem; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>

<canvas id="visualizer"></canvas>

<div class="container" id="startScreen">
  <h1>V-Index</h1>
  <p class="subtitle">Quantum Resistant Physical TRNG</p>
  <button id="initBtn" onclick="initAudio()">INITIALIZE SYSTEM</button>
  <div class="security-info">
    <strong>Requirements:</strong> HTTPS + Microphone permission. Keys are generated by the browser’s CSPRNG; microphone noise and V-index are hashed and mixed as supplemental entropy.
  </div>
</div>

<div class="container" id="mainDisplay" style="display:none;">
  <h1>V-INDEX</h1>

  <div class="status" id="status">Waiting for Entropy...</div>
  <div id="vNum">0.00</div>
  <div class="substatus" id="healthStatus">Health: <span class="pill" id="healthPill">initializing…</span></div>

  <div class="key-display" id="keyOut">LOCKED: Create noise to unlock generator…</div>

  <div class="controls">
    <button id="harvestBtn" onclick="generateKey()" disabled>HARVEST KEY</button>
    <button id="copyBtn" onclick="copyToClipboard()" style="background:transparent; color:#00ffcc; border:1px solid #00ffcc;">COPY</button>
  </div>

  <div class="security-info">
    <strong>V-INDEX MATH & RESEARCH:</strong><br>
    Scientific Reference: <a href="https://doi.org/10.5281/zenodo.18147084" target="_blank" class="doi-link">doi.org/10.5281/zenodo.18147084</a>
    <div id="vDetails">
      <div>> Average (a): <span id="vd_a">-</span></div>
      <div>> Weighted center (I): <span id="vd_I">-</span></div>
      <div>> DeltaS (ΔS): <span id="vd_dS">-</span></div>
      <div>> Raw V: <span id="vd_Vraw">-</span></div>
      <div>> Final V-Index: <span id="vd_Vfinal">-</span></div>
    </div>
  </div>

  <div class="security-info" id="secInfo">
    <strong>ENTROPY GATE:</strong> Generator locks if <strong>V &lt; 1.50</strong> or if <strong>health tests fail</strong>.
    Keys are CSPRNG‑derived; mic entropy and V-index are hashed (SHA‑256) and mixed.
  </div>
</div>

<script>
let audioContext, analyser, dataArray, canvas, ctx;
let visualizerInitialized = false;
let entropyBuffer = [];
let micDigest = null;
let healthOK = false;
let healthReason = 'initializing';
let repHashPrev = null;
let repCount = 0;
const REPETITION_THRESHOLD = 32;
const AP_WINDOW = 256;
let apWindow = [];
const AP_THRESHOLD = 0.80;

async function initAudio() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') await audioContext.resume();

    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('mainDisplay').style.display = 'block';

    setupVisualizer();
    update();
  } catch (err) {
    alert("Error: HTTPS and microphone permission required!");
  }
}

function setupVisualizer() {
  canvas = document.getElementById('visualizer');
  ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  visualizerInitialized = true;
}

function calculateV() {
  if (!analyser) return { v: 0, rawData: [], a: 0, I: 0, dS: 0, vRaw: 0 };
  analyser.getByteFrequencyData(dataArray);
  const N = dataArray.length;
  let sum = 0, weightedSum = 0;
  for (let i = 0; i < N; i++) {
    sum += dataArray[i];
    weightedSum += dataArray[i] * i;
  }
  const a = sum / N;
  const I = sum > 0 ? (weightedSum / sum) * 5 : 0;
  let dev = 0;
  for (let i = 0; i < N; i++) dev += Math.abs(dataArray[i] - a);
  const dS = (dev / N) + 5;
  let vRaw = (I + a) / (dS * 0.75) / 3;
  let v = vRaw;
  if (v > 4) v = 2.45 + Math.log(v / 2.45);
  if (isNaN(v) || v < 0) v = 0;
  return { v, rawData: dataArray, a, I, dS, vRaw };
}

function updateHealth(u8) {
  let fp = 0;
  for (let i = 0; i < u8.length; i++) fp = (fp + u8[i] * (i + 1)) & 0xffff;
  if (repHashPrev === fp) repCount++; else { repCount = 0; repHashPrev = fp; }
  const repFail = repCount >= REPETITION_THRESHOLD;

  let sum = 0, wsum = 0;
  for (let i = 0; i < u8.length; i++) { sum += u8[i]; wsum += u8[i] * i; }
  const sym = sum ? Math.max(0, Math.min(15, Math.floor((wsum/sum/u8.length)*16))) : 0;
  apWindow.push(sym);
  if (apWindow.length > AP_WINDOW) apWindow.shift();
  let apFail = false;
  if (apWindow.length === AP_WINDOW) {
    const counts = new Array(16).fill(0);
    for (const s of apWindow) counts[s]++;
    apFail = (Math.max(...counts) / AP_WINDOW) > AP_THRESHOLD;
  }
  healthOK = !(repFail || apFail);
  const pill = document.getElementById('healthPill');
  pill.textContent = healthOK ? 'OK' : 'FAIL';
  pill.className = healthOK ? 'pill ok' : 'pill bad';
}

async function secureGenerateKey(len = 24, vParts) {
  const vBuf = new ArrayBuffer(40);
  const dv = new DataView(vBuf);
  [vParts.a, vParts.I, vParts.dS, vParts.vRaw, vParts.v].forEach((n, i) => dv.setFloat64(i*8, n, true));
  const vHash = new Uint8Array(await crypto.subtle.digest('SHA-256', vBuf));
  
  const micData = new Uint8Array(entropyBuffer.slice(-2048));
  const micHash = new Uint8Array(await crypto.subtle.digest('SHA-256', micData));
  
  const cs = new Uint8Array(64);
  crypto.getRandomValues(cs);
  
  const combined = new Uint8Array(cs.length + micHash.length + vHash.length);
  combined.set(cs); combined.set(micHash, 64); combined.set(vHash, 96);
  
  let entropyPool = new Uint8Array(await crypto.subtle.digest('SHA-256', combined));
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
  let key = "";
  while(key.length < len) {
    for(let b of entropyPool) {
      if(b < 252 && key.length < len) key += alphabet[b % alphabet.length];
    }
    entropyPool = new Uint8Array(await crypto.subtle.digest('SHA-256', entropyPool));
  }
  for (let i = 0; i < len; i++) createBitSpark(i);
  return key;
}

async function generateKey() {
  const data = calculateV();
  if (data.v < 1.5 || !healthOK) return;
  const key = await secureGenerateKey(24, data);
  document.getElementById('keyOut').innerText = key;
  document.getElementById('keyOut').style.borderColor = "#ffd700";
}

function createBitSpark(index) {
  const spark = document.createElement('div');
  spark.className = 'bit-spark';
  document.body.appendChild(spark);
  const x = Math.random() * window.innerWidth, y = Math.random() * window.innerHeight;
  const target = document.getElementById('keyOut').getBoundingClientRect();
  spark.style.left = x + 'px'; spark.style.top = y + 'px';
  spark.style.width = '4px'; spark.style.height = '4px';
  spark.animate([{opacity: 1}, {transform: `translate(${target.left - x + 100}px, ${target.top - y + 30}px) scale(0)`, opacity: 0}], {duration: 600});
  setTimeout(() => spark.remove(), 600);
}

function copyToClipboard() {
  const text = document.getElementById('keyOut').innerText;
  if (text.includes("LOCKED")) return;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.innerText = "COPIED!";
    setTimeout(() => btn.innerText = "COPY", 1000);
  });
}

function update() {
  const data = calculateV();
  updateHealth(data.rawData);
  entropyBuffer.push(...data.rawData.slice(0, 64));
  if (entropyBuffer.length > 4096) entropyBuffer.shift();

  const vDisp = document.getElementById('vNum'), sDisp = document.getElementById('status');
  const hBtn = document.getElementById('harvestBtn'), kOut = document.getElementById('keyOut');
  
  vDisp.innerText = data.v.toFixed(2);
  const isOK = data.v >= 1.5 && healthOK;
  
  hBtn.disabled = !isOK;
  vDisp.style.color = isOK ? (data.v >= 2.4 ? "#ffd700" : "#00ffcc") : "#ff4444";
  sDisp.innerText = isOK ? "READY" : "LOCKED";
  sDisp.style.color = vDisp.style.color;

  document.getElementById('vd_a').textContent = data.a.toFixed(4);
  document.getElementById('vd_I').textContent = data.I.toFixed(4);
  document.getElementById('vd_dS').textContent = data.dS.toFixed(4);
  document.getElementById('vd_Vraw').textContent = data.vRaw.toFixed(4);
  document.getElementById('vd_Vfinal').textContent = data.v.toFixed(4);

  if (visualizerInitialized) {
    ctx.fillStyle = 'rgba(5,7,10,0.2)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const bw = (canvas.width / data.rawData.length) * 2;
    for (let i = 0; i < data.rawData.length; i++) {
      ctx.fillStyle = `hsl(${i * 2 + 160}, 100%, 50%)`;
      ctx.fillRect(i * bw, canvas.height - (data.rawData[i]/255*canvas.height), bw - 1, canvas.height);
    }
  }
  requestAnimationFrame(update);
}
</script>
</body>
</html>
